<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>İşyeri Hekimliği Uygulaması</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #2980b9;
            --primary-hover: #3498db;
            --secondary-color: #7f8c8d;
            --secondary-hover: #95a5a6;
            --success-color: #27ae60;
            --success-hover: #2ecc71;
            --danger-color: #e74c3c;
            --danger-hover: #c0392b;
            --warning-color: #f39c12;
            --warning-hover: #e67e22;
            --light-color: #ecf0f1;
            --dark-color: #2c3e50;
            --border-color: #ddd;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }

        #app {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Giriş Ekranı */
        .login-screen {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-hover) 100%);
        }

        .login-container {
            background: white;
            padding: 2.5rem;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 400px;
            text-align: center;
        }

        .login-container h1 {
            color: var(--primary-color);
            margin-bottom: 1.5rem;
        }

        .input-group {
            margin-bottom: 1.5rem;
            text-align: left;
        }

        .input-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }

        .error-message {
            color: var(--danger-color);
            margin-top: 1rem;
            display: none;
            font-size: 0.9rem;
        }

        /* Ana Uygulama */
        .app-header {
            background-color: var(--primary-color);
            color: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .content-area {
            flex: 1;
            padding: 1.5rem;
            background-color: white;
        }

        /* İşyeri Listesi */
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .workplace-list {
            list-style: none;
            padding: 0;
        }

        .workplace-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: var(--light-color);
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            border-left: 4px solid var(--primary-color);
        }

        .workplace-info {
            flex: 1;
            cursor: pointer;
        }

        .workplace-actions {
            display: flex;
            gap: 0.5rem;
        }

        .workplace-actions button {
            font-size: 0.8rem;
            padding: 0.25rem 0.5rem;
        }

        /* Çalışan Tablosu */
        .table-container {
            margin-top: 1.5rem;
            overflow-x: auto;
        }

        .table-actions {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            margin-top: 1rem;
        }

        .employee-actions {
            display: flex;
            gap: 0.5rem;
        }

        .employee-actions button {
            font-size: 0.8rem;
            padding: 0.25rem 0.5rem;
        }

        /* Modal İçeriği */
        .modal-content {
            border-radius: 10px;
        }

        .modal-header {
            border-bottom: 1px solid var(--border-color);
        }

        .modal-footer {
            border-top: 1px solid var(--border-color);
        }

        /* Buton stilleri */
        .btn-warning {
            background-color: var(--warning-color);
            color: white;
        }

        .btn-warning:hover {
            background-color: var(--warning-hover);
            color: white;
        }

        /* EK-2 Formu Stilleri */
        .signature-line {
            height: 1px;
            background-color: #000;
            margin: 10px 0;
            width: 100%;
        }

        .modal-body {
            max-height: 70vh;
            overflow-y: auto;
        }
        
        .ek2-form {
            font-size: 0.85rem;
        }
        
        .ek2-form table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 0.5rem;
        }
        
        .ek2-form th, .ek2-form td {
            border: 1px solid #ddd;
            padding: 6px;
            text-align: left;
            vertical-align: top;
        }
        
        .ek2-form th {
            background-color: #f2f2f2;
            font-weight: bold;
        }
        
        .ek2-form .section-title {
            background-color: #e9ecef;
            padding: 8px;
            margin-top: 1.2rem;
            margin-bottom: 0.5rem;
            font-weight: bold;
            border-left: 4px solid var(--primary-color);
        }
        
        .ek2-form .sub-section {
            padding-left: 1rem;
        }
        
        .ek2-form .signature-box {
            margin-top: 2rem;
            padding: 1rem;
            border: 1px solid #000;
            border-radius: 5px;
        }
        
        .ek2-form .form-group-row {
            display: flex;
            align-items: center;
            gap: 5px;
            margin-bottom: 5px;
        }
        
        .ek2-form .form-group-row input {
            width: 80px;
        }

        @media print {
            body * {
                visibility: hidden;
            }
            #ek2Modal .modal-content, 
            #ek2Modal .modal-content * {
                visibility: visible;
            }
            #ek2Modal .modal-content {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
            .no-print {
                display: none !important;
            }
        }

        /* Yedek Butonları */
        .backup-buttons {
            display: flex;
            gap: 10px;
            margin-right: 15px;
        }

        /* Dosya Listesi */
        .file-list {
            margin-top: 15px;
        }
        
        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            border-bottom: 1px solid #eee;
        }
        
        .file-actions {
            display: flex;
            gap: 5px;
        }

        /* Responsive Düzen */
        @media (max-width: 768px) {
            .login-container {
                padding: 1.5rem;
                margin: 1rem;
            }

            .section-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }

            .workplace-item {
                flex-direction: column;
                align-items: flex-start;
            }

            .workplace-actions {
                width: 100%;
                justify-content: flex-end;
                margin-top: 0.5rem;
            }

            .table-actions {
                flex-direction: column;
            }
            
            .employee-actions {
                flex-direction: column;
                gap: 0.25rem;
            }
            
            .app-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .backup-buttons {
                margin-top: 10px;
                width: 100%;
                justify-content: flex-end;
            }
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- Giriş Ekranı -->
        <div class="login-screen" id="loginScreen">
            <div class="login-container">
                <h1><i class="fas fa-user-md"></i> İşyeri Hekimliği</h1>
                <div class="input-group">
                    <label for="username">Kullanıcı Adı</label>
                    <input type="text" id="username" class="form-control" placeholder="Kullanıcı adınız">
                </div>
                <div class="input-group">
                    <label for="password">Şifre</label>
                    <input type="password" id="password" class="form-control" placeholder="Şifreniz">
                </div>
                <button id="loginBtn" class="btn btn-primary w-100">Giriş Yap</button>
                <div id="loginError" class="error-message"></div>
            </div>
        </div>

        <!-- Ana Uygulama -->
        <div id="mainApp" style="display: none;">
            <header class="app-header">
                <h2 id="welcomeText"></h2>
                <div class="d-flex align-items-center">
                    <div class="backup-buttons">
                        <button id="backupBtn" class="btn btn-light me-2">
                            <i class="fas fa-download"></i> Yedek Al
                        </button>
                        <button id="restoreBtn" class="btn btn-light me-2">
                            <i class="fas fa-upload"></i> Yedekten Dön
                        </button>
                    </div>
                    <div>
                        <button id="doctorInfoBtn" class="btn btn-light me-2">
                            <i class="fas fa-user-md"></i> Doktor Bilgileri
                        </button>
                        <button id="logoutBtn" class="btn btn-light">
                            <i class="fas fa-sign-out-alt"></i> Çıkış Yap
                        </button>
                    </div>
                </div>
            </header>

            <div class="content-area">
                <!-- İşyeri Listesi -->
                <div id="workplaceSection">
                    <div class="section-header">
                        <h3><i class="fas fa-building"></i> İşyerleri</h3>
                        <div>
                            <button id="addWorkplaceBtn" class="btn btn-success">
                                <i class="fas fa-plus"></i> Yeni İşyeri
                            </button>
                        </div>
                    </div>
                    <ul class="workplace-list" id="workplaceList"></ul>
                </div>

                <!-- Çalışan Listesi -->
                <div id="employeeSection" style="display: none;">
                    <div class="section-header">
                        <button id="backBtn" class="btn btn-secondary me-2">
                            <i class="fas fa-arrow-left"></i> Geri
                        </button>
                        <h3 id="currentWorkplaceTitle"></h3>
                        <div>
                            <button id="addEmployeeBtn" class="btn btn-success me-2">
                                <i class="fas fa-plus"></i> Yeni Çalışan
                            </button>
                            <button id="importExcelBtn" class="btn btn-info me-2">
                                <i class="fas fa-file-import"></i> Excel'den Al
                            </button>
                            <button id="exportExcelBtn" class="btn btn-warning">
                                <i class="fas fa-file-export"></i> Excel'e Aktar
                            </button>
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="table table-striped" id="employeeTable">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Ad Soyad</th>
                                    <th>TCKN</th>
                                    <th>Muayene Tarihi</th>
                                    <th>Sonraki Muayene</th>
                                    <th>İşlemler</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modaller -->
    <!-- İşyeri Modalı -->
    <div class="modal fade" id="workplaceModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitle">Yeni İşyeri</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="workplaceNameInput" class="form-label">İşyeri Adı</label>
                        <input type="text" class="form-control" id="workplaceNameInput">
                    </div>
                    <div class="mb-3">
                        <label for="workplaceAddressInput" class="form-label">Adres</label>
                        <textarea class="form-control" id="workplaceAddressInput" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                    <button type="button" class="btn btn-primary" id="saveWorkplaceBtn">Kaydet</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Çalışan Modalı -->
    <div class="modal fade" id="employeeModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="employeeModalTitle">Yeni Çalışan</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="employeeNameInput" class="form-label">Ad Soyad</label>
                        <input type="text" class="form-control" id="employeeNameInput">
                    </div>
                    <div class="mb-3">
                        <label for="employeeTcknInput" class="form-label">TC Kimlik No</label>
                        <input type="text" class="form-control" id="employeeTcknInput">
                    </div>
                    <div class="mb-3">
                        <label for="employeeExamDateInput" class="form-label">Muayene Tarihi</label>
                        <input type="date" class="form-control" id="employeeExamDateInput">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                    <button type="button" class="btn btn-primary" id="saveEmployeeBtn">Kaydet</button>
                </div>
            </div>
        </div>
    </div>

    <!-- EK-2 Modalı -->
    <div class="modal fade" id="ek2Modal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">EK-2 Formu</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="ek2FormContent"></div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Kapat</button>
                    <button type="button" class="btn btn-primary" id="saveEk2Btn">Kaydet</button>
                    <button type="button" class="btn btn-success" id="printEk2Btn">
                        <i class="fas fa-print"></i> Yazdır
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Dosya Yükleme Modalı -->
    <div class="modal fade" id="fileUploadModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Dosya Yükle</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="file" id="fileInput" class="form-control">
                    <div class="mt-3" id="uploadedFilesList"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                    <button type="button" class="btn btn-primary" id="uploadFileBtn">Yükle</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Doktor Bilgileri Modalı -->
    <div class="modal fade" id="doctorInfoModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Doktor Bilgileri</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="doctorNameInput" class="form-label">Adı Soyadı</label>
                        <input type="text" class="form-control" id="doctorNameInput">
                    </div>
                    <div class="mb-3">
                        <label for="diplomaNoInput" class="form-label">Diploma No</label>
                        <input type="text" class="form-control" id="diplomaNoInput">
                    </div>
                    <div class="mb-3">
                        <label for="diplomaDateInput" class="form-label">Diploma Tarihi</label>
                        <input type="date" class="form-control" id="diplomaDateInput">
                    </div>
                    <div class="mb-3">
                        <label for="certificateNoInput" class="form-label">Sertifika No</label>
                        <input type="text" class="form-control" id="certificateNoInput">
                    </div>
                    <div class="mb-3">
                        <label for="certificateDateInput" class="form-label">Sertifika Tarihi</label>
                        <input type="date" class="form-control" id="certificateDateInput">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                    <button type="button" class="btn btn-primary" id="saveDoctorInfoBtn">Kaydet</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Yedekten Dönme Modalı -->
    <div class="modal fade" id="restoreModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Yedekten Dön</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Yedek Dosyası Seçin</label>
                        <input type="file" id="backupFileInput" class="form-control" accept=".json">
                    </div>
                    <div class="alert alert-warning">
                        <strong>Uyarı:</strong> Bu işlem mevcut tüm verilerinizin üzerine yazacaktır.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                    <button type="button" class="btn btn-danger" id="confirmRestoreBtn">Yedekten Dön</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
    <script>
        // Veritabanı Sınıfı
        class Database {
            constructor() {
                this.dbName = 'isyeriHekimligiDB';
                this.version = 9; // Versiyonu artırdık
                this.db = null;
            }

            async initDB() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(this.dbName, this.version);

                    request.onerror = (event) => {
                        console.error("Veritabanı hatası:", event.target.error);
                        reject(event.target.error);
                    };

                    request.onsuccess = (event) => {
                        this.db = event.target.result;
                        resolve(this.db);
                    };

                    request.onupgradeneeded = (event) => {
                        const db = event.target.result;
                        
                        if (!db.objectStoreNames.contains('workplaces')) {
                            db.createObjectStore('workplaces', { keyPath: 'id' });
                        }
                        
                        let employeeStore;
                        if (!db.objectStoreNames.contains('employees')) {
                            employeeStore = db.createObjectStore('employees', { keyPath: 'id' });
                        } else {
                            employeeStore = event.target.transaction.objectStore('employees');
                        }
                        
                        if (!employeeStore.indexNames.contains('workplaceId')) {
                            employeeStore.createIndex('workplaceId', 'workplaceId', { unique: false });
                        }

                        if (!db.objectStoreNames.contains('files')) {
                            const filesStore = db.createObjectStore('files', { keyPath: 'id' });
                            filesStore.createIndex('employeeId', 'employeeId', { unique: false });
                        }

                        // EK-2 formları için yeni tablo
                        if (!db.objectStoreNames.contains('ek2Forms')) {
                            const ek2FormsStore = db.createObjectStore('ek2Forms', { keyPath: 'employeeId' });
                        }
                    };
                });
            }

            async getWorkplaces() {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['workplaces'], 'readonly');
                    const store = transaction.objectStore('workplaces');
                    const request = store.getAll();

                    request.onsuccess = () => resolve(request.result);
                    request.onerror = (event) => reject(event.target.error);
                });
            }

            async addWorkplace(workplace) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['workplaces'], 'readwrite');
                    const store = transaction.objectStore('workplaces');
                    const request = store.add(workplace);

                    request.onsuccess = () => resolve(request.result);
                    request.onerror = (event) => reject(event.target.error);
                });
            }

            async updateWorkplace(workplace) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['workplaces'], 'readwrite');
                    const store = transaction.objectStore('workplaces');
                    const request = store.put(workplace);

                    request.onsuccess = () => resolve(request.result);
                    request.onerror = (event) => reject(event.target.error);
                });
            }

            async deleteWorkplace(id) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['workplaces'], 'readwrite');
                    const store = transaction.objectStore('workplaces');
                    const request = store.delete(id);

                    request.onsuccess = () => resolve(request.result);
                    request.onerror = (event) => reject(event.target.error);
                });
            }

            async getEmployees(workplaceId) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['employees'], 'readonly');
                    const store = transaction.objectStore('employees');
                    const index = store.index('workplaceId');
                    const request = index.getAll(workplaceId);

                    request.onsuccess = () => resolve(request.result);
                    request.onerror = (event) => reject(event.target.error);
                });
            }

            async getAllEmployees() {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['employees'], 'readonly');
                    const store = transaction.objectStore('employees');
                    const request = store.getAll();

                    request.onsuccess = () => resolve(request.result);
                    request.onerror = (event) => reject(event.target.error);
                });
            }

            async addEmployee(employee) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['employees'], 'readwrite');
                    const store = transaction.objectStore('employees');
                    const request = store.add(employee);

                    request.onsuccess = () => resolve(request.result);
                    request.onerror = (event) => reject(event.target.error);
                });
            }

            async updateEmployee(employee) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['employees'], 'readwrite');
                    const store = transaction.objectStore('employees');
                    const request = store.put(employee);

                    request.onsuccess = () => resolve(request.result);
                    request.onerror = (event) => reject(event.target.error);
                });
            }

            async deleteEmployee(id) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['employees'], 'readwrite');
                    const store = transaction.objectStore('employees');
                    const request = store.delete(id);

                    request.onsuccess = () => resolve(request.result);
                    request.onerror = (event) => reject(event.target.error);
                });
            }

            async addFile(file) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['files'], 'readwrite');
                    const store = transaction.objectStore('files');
                    const request = store.add(file);

                    request.onsuccess = () => resolve(request.result);
                    request.onerror = (event) => reject(event.target.error);
                });
            }

            async getFilesByEmployee(employeeId) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['files'], 'readonly');
                    const store = transaction.objectStore('files');
                    const index = store.index('employeeId');
                    const request = index.getAll(employeeId);

                    request.onsuccess = () => resolve(request.result);
                    request.onerror = (event) => reject(event.target.error);
                });
            }

            async deleteFile(id) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['files'], 'readwrite');
                    const store = transaction.objectStore('files');
                    const request = store.delete(id);

                    request.onsuccess = () => resolve(request.result);
                    request.onerror = (event) => reject(event.target.error);
                });
            }

            async getAllFiles() {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['files'], 'readonly');
                    const store = transaction.objectStore('files');
                    const request = store.getAll();

                    request.onsuccess = () => resolve(request.result);
                    request.onerror = (event) => reject(event.target.error);
                });
            }

            async saveEk2Form(ek2Form) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['ek2Forms'], 'readwrite');
                    const store = transaction.objectStore('ek2Forms');
                    const request = store.put(ek2Form);

                    request.onsuccess = () => resolve(request.result);
                    request.onerror = (event) => reject(event.target.error);
                });
            }

            async getEk2FormByEmployee(employeeId) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['ek2Forms'], 'readonly');
                    const store = transaction.objectStore('ek2Forms');
                    const request = store.get(employeeId);

                    request.onsuccess = () => resolve(request.result);
                    request.onerror = (event) => reject(event.target.error);
                });
            }

            async getAllEk2Forms() {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['ek2Forms'], 'readonly');
                    const store = transaction.objectStore('ek2Forms');
                    const request = store.getAll();

                    request.onsuccess = () => resolve(request.result);
                    request.onerror = (event) => reject(event.target.error);
                });
            }

            async clearObjectStore(storeName) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([storeName], 'readwrite');
                    const store = transaction.objectStore(storeName);
                    const request = store.clear();

                    request.onsuccess = () => resolve();
                    request.onerror = (event) => reject(event.target.error);
                });
            }
        }

        // Uygulama State'i
        const appState = {
            db: new Database(),
            currentUser: null,
            currentWorkplace: null,
            currentEmployees: [],
            currentEmployeeIndex: null,
            currentFileUploadIndex: null,
            isEditingWorkplace: false,
            isEditingEmployee: false
        };

        // Sayfa Yüklendiğinde
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                await appState.db.initDB();
                initLogin();
                checkAuth();
                initModals();
                initWorkplaceActions();
                initEmployeeActions();
                initDoctorInfo();
                initLogout();
                initBackButton();
                initBackupRestore();
            } catch (error) {
                console.error('Başlatma hatası:', error);
                showError('Uygulama başlatılırken bir hata oluştu: ' + error.message);
            }
        });

        // Giriş İşlemleri
        function initLogin() {
            const loginBtn = document.getElementById('loginBtn');
            if (loginBtn) {
                loginBtn.addEventListener('click', login);
            }
            
            document.getElementById('password').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    login();
                }
            });
        }

        async function login() {
            try {
                const username = document.getElementById('username').value.trim();
                const password = document.getElementById('password').value.trim();
                const errorElement = document.getElementById('loginError');

                errorElement.textContent = '';
                
                if (!username || !password) {
                    throw new Error('Kullanıcı adı ve şifre gereklidir');
                }

                if (username === 'hekim' && password === 'Sifre123!') {
                    localStorage.setItem('authToken', 'demo-token');
                    appState.currentUser = { username, role: 'doctor' };
                    showMainView();
                    await loadWorkplaces();
                } else {
                    throw new Error('Geçersiz kullanıcı adı veya şifre!');
                }
            } catch (error) {
                console.error('Giriş hatası:', error);
                showError(error.message);
            }
        }

        function showError(message) {
            const errorElement = document.getElementById('loginError');
            if (errorElement) {
                errorElement.textContent = message;
                errorElement.style.display = 'block';
            } else {
                alert(message);
            }
        }

        function checkAuth() {
            if (localStorage.getItem('authToken')) {
                appState.currentUser = { username: 'hekim', role: 'doctor' };
                showMainView();
                loadWorkplaces();
            }
        }

        function showMainView() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            document.getElementById('welcomeText').textContent = `Hoş geldiniz, ${appState.currentUser.username}`;
        }

        // Çıkış İşlemi
        function initLogout() {
            const logoutBtn = document.getElementById('logoutBtn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', () => {
                    localStorage.removeItem('authToken');
                    location.reload();
                });
            }
        }

        // Modal İşlemleri
        function initModals() {
            // Bootstrap modal yapısı kullanıldığı için ekstra init gerekmiyor
        }

        // İşyeri İşlemleri
        async function loadWorkplaces() {
            try {
                const workplaces = await appState.db.getWorkplaces();
                
                if (workplaces.length === 0) {
                    await addDemoData();
                    return loadWorkplaces();
                }

                renderWorkplaces(workplaces);
            } catch (error) {
                console.error('İşyerleri yüklenirken hata:', error);
                showError('İşyerleri yüklenirken hata oluştu');
            }
        }

        async function addDemoData() {
            const demoWorkplaces = [
                { id: '1', name: 'Örnek İşyeri 1', address: 'Örnek Adres 1', createdAt: new Date().toISOString() },
                { id: '2', name: 'Örnek İşyeri 2', address: 'Örnek Adres 2', createdAt: new Date().toISOString() }
            ];

            for (const workplace of demoWorkplaces) {
                await appState.db.addWorkplace(workplace);
            }
        }

        function renderWorkplaces(workplaces) {
            const listElement = document.getElementById('workplaceList');
            listElement.innerHTML = '';

            workplaces.forEach(workplace => {
                const li = document.createElement('li');
                li.className = 'workplace-item';
                li.innerHTML = `
                    <div class="workplace-info">
                        <h4>${workplace.name}</h4>
                        <p>${workplace.address || 'Adres bilgisi yok'}</p>
                    </div>
                    <div class="workplace-actions">
                        <button class="btn btn-sm btn-warning edit-workplace" data-id="${workplace.id}">Düzenle</button>
                        <button class="btn btn-sm btn-danger delete-workplace" data-id="${workplace.id}">Sil</button>
                    </div>
                `;
                
                li.querySelector('.workplace-info').addEventListener('click', async () => {
                    appState.currentWorkplace = workplace;
                    await showWorkplaceDetails(workplace);
                });
                
                listElement.appendChild(li);
            });

            document.querySelectorAll('.edit-workplace').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const workplaceId = e.target.getAttribute('data-id');
                    const workplace = workplaces.find(w => w.id === workplaceId);
                    if (workplace) {
                        appState.isEditingWorkplace = true;
                        appState.currentWorkplace = workplace;
                        document.getElementById('modalTitle').textContent = 'İşyeri Düzenle';
                        document.getElementById('workplaceNameInput').value = workplace.name;
                        document.getElementById('workplaceAddressInput').value = workplace.address || '';
                        const workplaceModal = new bootstrap.Modal(document.getElementById('workplaceModal'));
                        workplaceModal.show();
                    }
                });
            });

            document.querySelectorAll('.delete-workplace').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const workplaceId = e.target.getAttribute('data-id');
                    const workplace = workplaces.find(w => w.id === workplaceId);
                    if (workplace && confirm(`${workplace.name} işyerini silmek istediğinize emin misiniz?`)) {
                        try {
                            const employees = await appState.db.getEmployees(workplaceId);
                            for (const employee of employees) {
                                await appState.db.deleteEmployee(employee.id);
                            }
                            
                            await appState.db.deleteWorkplace(workplaceId);
                            await loadWorkplaces();
                        } catch (error) {
                            console.error('İşyeri silme hatası:', error);
                            showError('İşyeri silinirken hata oluştu');
                        }
                    }
                });
            });
        }

        async function showWorkplaceDetails(workplace) {
            document.getElementById('workplaceSection').style.display = 'none';
            document.getElementById('employeeSection').style.display = 'block';
            document.getElementById('currentWorkplaceTitle').textContent = workplace.name;
            await loadEmployees(workplace.id);
        }

        // Geri Butonu
        function initBackButton() {
            const backBtn = document.getElementById('backBtn');
            if (backBtn) {
                backBtn.addEventListener('click', () => {
                    document.getElementById('employeeSection').style.display = 'none';
                    document.getElementById('workplaceSection').style.display = 'block';
                    document.getElementById('employeeTable').querySelector('tbody').innerHTML = '';
                    appState.currentWorkplace = null;
                });
            }
        }

        // Çalışan İşlemleri
        async function loadEmployees(workplaceId) {
            try {
                const employees = await appState.db.getEmployees(workplaceId);
                appState.currentEmployees = employees;
                renderEmployees(employees);
            } catch (error) {
                console.error('Çalışanlar yüklenirken hata:', error);
                showError('Çalışanlar yüklenirken hata oluştu');
            }
        }

        function renderEmployees(employees) {
            const tbody = document.getElementById('employeeTable').querySelector('tbody');
            tbody.innerHTML = '';

            if (employees.length === 0) {
                const tr = document.createElement('tr');
                tr.innerHTML = '<td colspan="6" style="text-align: center;">Henüz çalışan eklenmemiş</td>';
                tbody.appendChild(tr);
                return;
            }

            employees.forEach((emp, index) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${emp.name || ''}</td>
                    <td>${emp.tckn || ''}</td>
                    <td>${emp.examDate ? formatDate(emp.examDate) : ''}</td>
                    <td>${emp.nextExamDate ? formatDate(emp.nextExamDate) : ''}</td>
                    <td>
                        <div class="employee-actions">
                            <button class="btn btn-sm btn-primary ek2-btn">EK-2</button>
                            <button class="btn btn-sm btn-secondary upload-btn">EK-2 Yükle</button>
                            <button class="btn btn-sm btn-info edit-employee">Düzenle</button>
                            <button class="btn btn-sm btn-danger delete-employee">Sil</button>
                        </div>
                    </td>
                `;
                
                // Butonlara olay dinleyicileri ekle
                const ek2Btn = tr.querySelector('.ek2-btn');
                ek2Btn.addEventListener('click', () => {
                    showEk2Modal(index);
                });
                
                const uploadBtn = tr.querySelector('.upload-btn');
                uploadBtn.addEventListener('click', () => {
                    showFileUploadModal(index);
                });
                
                const editBtn = tr.querySelector('.edit-employee');
                editBtn.addEventListener('click', () => {
                    editEmployee(index);
                });
                
                const deleteBtn = tr.querySelector('.delete-employee');
                deleteBtn.addEventListener('click', async () => {
                    if (confirm('Bu çalışanı silmek istediğinize emin misiniz?')) {
                        try {
                            await appState.db.deleteEmployee(emp.id);
                            await loadEmployees(appState.currentWorkplace.id);
                        } catch (error) {
                            console.error('Çalışan silme hatası:', error);
                            showError('Çalışan silinirken hata oluştu');
                        }
                    }
                });
                
                tbody.appendChild(tr);
            });
        }

        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleDateString('tr-TR');
        }

        function editEmployee(index) {
            const employee = appState.currentEmployees[index];
            if (!employee) return;
            
            appState.isEditingEmployee = true;
            appState.currentEmployeeIndex = index;
            
            document.getElementById('employeeModalTitle').textContent = 'Çalışan Düzenle';
            document.getElementById('employeeNameInput').value = employee.name || '';
            document.getElementById('employeeTcknInput').value = employee.tckn || '';
            document.getElementById('employeeExamDateInput').value = employee.examDate ? new Date(employee.examDate).toISOString().split('T')[0] : '';
            
            const employeeModal = new bootstrap.Modal(document.getElementById('employeeModal'));
            employeeModal.show();
        }

        // EK-2 Formu
        async function showEk2Modal(employeeIndex) {
            const employee = appState.currentEmployees[employeeIndex];
            if (!employee) {
                console.error('Çalışan bulunamadı');
                return;
            }
            
            appState.currentEmployeeIndex = employeeIndex;
            
            const today = new Date();
            const formattedToday = today.toISOString().split('T')[0];
            
            const nextExamDate = new Date();
            nextExamDate.setFullYear(nextExamDate.getFullYear() + 5);
            const formattedNextExamDate = nextExamDate.toISOString().split('T')[0];
            
            const doctorInfo = JSON.parse(localStorage.getItem('doctorInfo')) || {};
            
            // EK-2 form verisini veritabanından yükle
            let ek2Data = {};
            try {
                const savedForm = await appState.db.getEk2FormByEmployee(employee.id);
                if (savedForm) {
                    ek2Data = savedForm.formData;
                }
            } catch (error) {
                console.error('EK-2 formu yüklenirken hata:', error);
            }
            
            // EK-2 form içeriğini oluştur
            const ek2Content = document.getElementById('ek2FormContent');
            ek2Content.innerHTML = `
                <div class="ek2-form">
                    <h4 class="text-center mb-4">EK-2 İŞE GİRİŞ/PERİYODİK MUAYENE FORMU</h4>
                    
                    <!-- İşyeri Bilgileri -->
                    <div class="mb-4">
                        <h5 class="section-title">İŞYERİNİN</h5>
                        <table>
                            <tr>
                                <th width="20%">Ünvanı</th>
                                <td><input type="text" class="form-control form-control-sm" id="workplace-title" value="${appState.currentWorkplace?.name || ''}"></td>
                            </tr>
                            <tr>
                                <th>SGK Sicil No.</th>
                                <td><input type="text" class="form-control form-control-sm" id="workplace-sgk" value="${ek2Data['workplace-sgk'] || ''}"></td>
                            </tr>
                            <tr>
                                <th>Adresi</th>
                                <td><input type="text" class="form-control form-control-sm" id="workplace-address" value="${appState.currentWorkplace?.address || ''}"></td>
                            </tr>
                            <tr>
                                <th>Tel ve Faks No</th>
                                <td><input type="text" class="form-control form-control-sm" id="workplace-phone" value="${ek2Data['workplace-phone'] || ''}"></td>
                            </tr>
                            <tr>
                                <th>E-Posta</th>
                                <td><input type="email" class="form-control form-control-sm" id="workplace-email" value="${ek2Data['workplace-email'] || ''}"></td>
                            </tr>
                        </table>
                    </div>

                    <!-- Çalışan Bilgileri -->
                    <div class="mb-4">
                        <h5 class="section-title">ÇALIŞANIN</h5>
                        <table>
                            <tr>
                                <th width="20%">Adı ve soyadı</th>
                                <td><input type="text" class="form-control form-control-sm" id="employee-name" value="${employee.name || ''}"></td>
                            </tr>
                            <tr>
                                <th>T.C.Kimlik No</th>
                                <td><input type="text" class="form-control form-control-sm" id="employee-tckn" value="${employee.tckn || ''}"></td>
                            </tr>
                            <tr>
                                <th>Doğum Yeri ve Tarihi</th>
                                <td><input type="text" class="form-control form-control-sm" id="employee-birth" value="${ek2Data['employee-birth'] || ''}"></td>
                            </tr>
                            <tr>
                                <th>Cinsiyeti</th>
                                <td>
                                    <select class="form-select form-select-sm" id="employee-gender">
                                        <option value="">Seçiniz</option>
                                        <option value="male" ${ek2Data['employee-gender'] === 'male' ? 'selected' : ''}>Erkek</option>
                                        <option value="female" ${ek2Data['employee-gender'] === 'female' ? 'selected' : ''}>Kadın</option>
                                    </select>
                                </td>
                            </tr>
                            <tr>
                                <th>Eğitim durumu</th>
                                <td><input type="text" class="form-control form-control-sm" id="employee-education" value="${ek2Data['employee-education'] || ''}"></td>
                            </tr>
                            <tr>
                                <th>Medeni durumu</th>
                                <td>
                                    <select class="form-select form-select-sm" id="employee-marital">
                                        <option value="">Seçiniz</option>
                                        <option value="single" ${ek2Data['employee-marital'] === 'single' ? 'selected' : ''}>Bekar</option>
                                        <option value="married" ${ek2Data['employee-marital'] === 'married' ? 'selected' : ''}>Evli</option>
                                        <option value="divorced" ${ek2Data['employee-marital'] === 'divorced' ? 'selected' : ''}>Boşanmış</option>
                                        <option value="widowed" ${ek2Data['employee-marital'] === 'widowed' ? 'selected' : ''}>Dul</option>
                                    </select>
                                </td>
                            </tr>
                            <tr>
                                <th>Çocuk sayısı</th>
                                <td><input type="number" class="form-control form-control-sm" id="employee-children" value="${ek2Data['employee-children'] || ''}"></td>
                            </tr>
                            <tr>
                                <th>Ev Adresi</th>
                                <td><input type="text" class="form-control form-control-sm" id="employee-address" value="${ek2Data['employee-address'] || ''}"></td>
                            </tr>
                            <tr>
                                <th>Tel No.</th>
                                <td><input type="tel" class="form-control form-control-sm" id="employee-phone" value="${ek2Data['employee-phone'] || ''}"></td>
                            </tr>
                            <tr>
                                <th>Mesleği</th>
                                <td><input type="text" class="form-control form-control-sm" id="employee-profession" value="${ek2Data['employee-profession'] || ''}"></td>
                            </tr>
                            <tr>
                                <th>Yaptığı iş (Ayrıntılı olarak tanımlanacaktır.)</th>
                                <td><textarea class="form-control form-control-sm" rows="2" id="employee-job">${ek2Data['employee-job'] || ''}</textarea></td>
                            </tr>
                            <tr>
                                <th>Çalıştığı bölüm</th>
                                <td><input type="text" class="form-control form-control-sm" id="employee-department" value="${ek2Data['employee-department'] || ''}"></td>
                            </tr>
                        </table>
                    </div>

                    <!-- Tıbbi Anamnez -->
                    <div class="mb-4">
                        <h5 class="section-title">TIBBİ ANAMNEZ</h5>
                        
                        <div class="sub-section">
                            <p><strong>1. Aşağıdaki yakınmalardan herhangi birini yaşadınız mı?</strong></p>
                            <table>
                                <tr>
                                    <td width="70%">- Balgamlı öksürük</td>
                                    <td class="text-center"><input type="checkbox" class="form-check-input" id="symptom-cough" ${ek2Data['symptom-cough'] ? 'checked' : ''}></td>
                                </tr>
                                <tr>
                                    <td>- Nefes darlığı</td>
                                    <td class="text-center"><input type="checkbox" class="form-check-input" id="symptom-breath" ${ek2Data['symptom-breath'] ? 'checked' : ''}></td>
                                </tr>
                                <tr>
                                    <td>- Göğüs ağrısı</td>
                                    <td class="text-center"><input type="checkbox" class="form-check-input" id="symptom-chest" ${ek2Data['symptom-chest'] ? 'checked' : ''}></td>
                                </tr>
                                <!-- Diğer semptomlar buraya eklenecek -->
                            </table>
                        </div>
                        
                        <!-- Diğer bölümler buraya eklenecek -->
                    </div>
                    
                    <!-- Doktor Bilgileri ve İmza -->
                    <div class="signature-box">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group-row">
                                    <label>Tarih:</label>
                                    <input type="text" class="form-control form-control-sm" value="${formattedToday}" style="width: 100px;">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="text-center">
                                    <div class="signature-line mb-2"></div>
                                    <p class="mb-0"><strong>İMZA</strong></p>
                                    <p class="mb-0">${doctorInfo.name || 'Doktor Adı Soyadı'}</p>
                                    <p class="small text-muted mb-0">Diploma Tarih ve No: ${doctorInfo.diplomaDate || ''} / ${doctorInfo.diplomaNo || ''}</p>
                                    <p class="small text-muted mb-0">Diploma Tescil Tarih ve No: ${doctorInfo.certificateDate || ''} / ${doctorInfo.certificateNo || ''}</p>
                                    <p class="small text-muted">İşyeri Hekimliği Belgesi Tarih ve No: ${doctorInfo.certificateDate || ''} / ${doctorInfo.certificateNo || ''}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            const ek2Modal = new bootstrap.Modal(document.getElementById('ek2Modal'));
            ek2Modal.show();
        }

        // Dosya Yükleme Modalı
        async function showFileUploadModal(employeeIndex) {
            const employee = appState.currentEmployees[employeeIndex];
            if (!employee) {
                console.error('Çalışan bulunamadı');
                return;
            }
            
            appState.currentFileUploadIndex = employeeIndex;
            document.getElementById('fileInput').value = '';
            
            // Yüklenen dosyaları listele
            const uploadedFilesList = document.getElementById('uploadedFilesList');
            uploadedFilesList.innerHTML = '';
            
            try {
                const files = await appState.db.getFilesByEmployee(employee.id);
                if (files.length > 0) {
                    uploadedFilesList.innerHTML = '<h6>Yüklenen Dosyalar:</h6>';
                    files.forEach(file => {
                        const fileItem = document.createElement('div');
                        fileItem.className = 'file-item';
                        fileItem.innerHTML = `
                            <span>${file.fileName}</span>
                            <div class="file-actions">
                                <button class="btn btn-sm btn-info download-file-btn" data-id="${file.id}">
                                    <i class="fas fa-download"></i>
                                </button>
                                <button class="btn btn-sm btn-danger delete-file-btn" data-id="${file.id}">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        `;
                        uploadedFilesList.appendChild(fileItem);
                        
                        // İndir butonu
                        fileItem.querySelector('.download-file-btn').addEventListener('click', async (e) => {
                            const fileId = e.target.closest('button').getAttribute('data-id');
                            const fileRecord = files.find(f => f.id === fileId);
                            if (fileRecord) {
                                const blob = new Blob([fileRecord.data], { type: fileRecord.fileType });
                                const url = URL.createObjectURL(blob);
                                const a = document.createElement('a');
                                a.href = url;
                                a.download = fileRecord.fileName;
                                document.body.appendChild(a);
                                a.click();
                                document.body.removeChild(a);
                                URL.revokeObjectURL(url);
                            }
                        });
                        
                        // Sil butonu
                        fileItem.querySelector('.delete-file-btn').addEventListener('click', async (e) => {
                            const fileId = e.target.closest('button').getAttribute('data-id');
                            if (confirm('Bu dosyayı silmek istediğinize emin misiniz?')) {
                                try {
                                    await appState.db.deleteFile(fileId);
                                    await showFileUploadModal(employeeIndex); // Modalı yenile
                                } catch (error) {
                                    console.error('Dosya silme hatası:', error);
                                    alert('Dosya silinirken hata oluştu');
                                }
                            }
                        });
                    });
                }
            } catch (error) {
                console.error('Dosyalar yüklenirken hata:', error);
            }
            
            const fileUploadModal = new bootstrap.Modal(document.getElementById('fileUploadModal'));
            fileUploadModal.show();
        }

        // Doktor Bilgileri İşlemleri
        function initDoctorInfo() {
            const doctorInfoBtn = document.getElementById('doctorInfoBtn');
            if (doctorInfoBtn) {
                doctorInfoBtn.addEventListener('click', () => {
                    loadDoctorInfo();
                    const doctorInfoModal = new bootstrap.Modal(document.getElementById('doctorInfoModal'));
                    doctorInfoModal.show();
                });
            }

            const saveDoctorInfoBtn = document.getElementById('saveDoctorInfoBtn');
            if (saveDoctorInfoBtn) {
                saveDoctorInfoBtn.addEventListener('click', saveDoctorInfo);
            }
        }

        function loadDoctorInfo() {
            const doctorInfo = JSON.parse(localStorage.getItem('doctorInfo')) || {};
            document.getElementById('doctorNameInput').value = doctorInfo.name || '';
            document.getElementById('diplomaNoInput').value = doctorInfo.diplomaNo || '';
            document.getElementById('diplomaDateInput').value = doctorInfo.diplomaDate || '';
            document.getElementById('certificateNoInput').value = doctorInfo.certificateNo || '';
            document.getElementById('certificateDateInput').value = doctorInfo.certificateDate || '';
        }

        function saveDoctorInfo() {
            const doctorInfo = {
                name: document.getElementById('doctorNameInput').value,
                diplomaNo: document.getElementById('diplomaNoInput').value,
                diplomaDate: document.getElementById('diplomaDateInput').value,
                certificateNo: document.getElementById('certificateNoInput').value,
                certificateDate: document.getElementById('certificateDateInput').value
            };
            localStorage.setItem('doctorInfo', JSON.stringify(doctorInfo));
            alert('Doktor bilgileri kaydedildi');
        }

        // Yedek Alma ve Yedekten Dönme
        function initBackupRestore() {
            const backupBtn = document.getElementById('backupBtn');
            if (backupBtn) {
                backupBtn.addEventListener('click', backupDatabase);
            }

            const restoreBtn = document.getElementById('restoreBtn');
            if (restoreBtn) {
                restoreBtn.addEventListener('click', () => {
                    const restoreModal = new bootstrap.Modal(document.getElementById('restoreModal'));
                    restoreModal.show();
                });
            }

            const confirmRestoreBtn = document.getElementById('confirmRestoreBtn');
            if (confirmRestoreBtn) {
                confirmRestoreBtn.addEventListener('click', restoreDatabase);
            }
        }

        async function backupDatabase() {
            try {
                const backupData = {
                    workplaces: await appState.db.getWorkplaces(),
                    employees: await appState.db.getAllEmployees(),
                    files: await appState.db.getAllFiles(),
                    ek2Forms: await appState.db.getAllEk2Forms(),
                    doctorInfo: JSON.parse(localStorage.getItem('doctorInfo')) || {},
                    timestamp: new Date().toISOString()
                };

                const dataStr = JSON.stringify(backupData);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `isyeri_hekimligi_backup_${new Date().toISOString().slice(0, 10)}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                alert('Yedekleme işlemi başarıyla tamamlandı.');
            } catch (error) {
                console.error('Yedekleme hatası:', error);
                alert('Yedekleme işlemi sırasında hata oluştu: ' + error.message);
            }
        }

        async function restoreDatabase() {
            const fileInput = document.getElementById('backupFileInput');
            if (!fileInput.files.length) {
                alert('Lütfen bir yedek dosyası seçin');
                return;
            }

            const file = fileInput.files[0];
            const reader = new FileReader();
            
            reader.onload = async (event) => {
                try {
                    const backupData = JSON.parse(event.target.result);
                    
                    if (!confirm('Bu işlem mevcut tüm verilerinizi silecektir. Devam etmek istiyor musunuz?')) {
                        return;
                    }

                    // Veritabanını temizle
                    await appState.db.clearObjectStore('workplaces');
                    await appState.db.clearObjectStore('employees');
                    await appState.db.clearObjectStore('files');
                    await appState.db.clearObjectStore('ek2Forms');

                    // Yedekten verileri geri yükle
                    for (const workplace of backupData.workplaces) {
                        await appState.db.addWorkplace(workplace);
                    }

                    for (const employee of backupData.employees) {
                        await appState.db.addEmployee(employee);
                    }

                    for (const file of backupData.files) {
                        await appState.db.addFile(file);
                    }

                    for (const form of backupData.ek2Forms) {
                        await appState.db.saveEk2Form(form);
                    }

                    // Doktor bilgilerini geri yükle
                    localStorage.setItem('doctorInfo', JSON.stringify(backupData.doctorInfo || {}));

                    alert('Yedekten dönme işlemi başarıyla tamamlandı.');
                    location.reload();
                } catch (error) {
                    console.error('Yedekten dönme hatası:', error);
                    alert('Yedekten dönme işlemi sırasında hata oluştu: ' + error.message);
                }
            };
            
            reader.readAsText(file);
        }

        // İşyeri ve Çalışan Eylemlerini Başlatma
        function initWorkplaceActions() {
            const addWorkplaceBtn = document.getElementById('addWorkplaceBtn');
            if (addWorkplaceBtn) {
                addWorkplaceBtn.addEventListener('click', () => {
                    appState.isEditingWorkplace = false;
                    appState.currentWorkplace = null;
                    document.getElementById('modalTitle').textContent = 'Yeni İşyeri';
                    document.getElementById('workplaceNameInput').value = '';
                    document.getElementById('workplaceAddressInput').value = '';
                    const workplaceModal = new bootstrap.Modal(document.getElementById('workplaceModal'));
                    workplaceModal.show();
                });
            }

            const saveWorkplaceBtn = document.getElementById('saveWorkplaceBtn');
            if (saveWorkplaceBtn) {
                saveWorkplaceBtn.addEventListener('click', async () => {
                    const name = document.getElementById('workplaceNameInput').value.trim();
                    const address = document.getElementById('workplaceAddressInput').value.trim();

                    if (!name) {
                        showError('İşyeri adı gereklidir');
                        return;
                    }

                    try {
                        if (appState.isEditingWorkplace && appState.currentWorkplace) {
                            const workplace = {
                                ...appState.currentWorkplace,
                                name,
                                address
                            };
                            await appState.db.updateWorkplace(workplace);
                        } else {
                            const workplace = {
                                id: Date.now().toString(),
                                name,
                                address,
                                createdAt: new Date().toISOString()
                            };
                            await appState.db.addWorkplace(workplace);
                        }
                        
                        await loadWorkplaces();
                        bootstrap.Modal.getInstance(document.getElementById('workplaceModal')).hide();
                    } catch (error) {
                        console.error('İşyeri ekleme/düzenleme hatası:', error);
                        showError('İşyeri işlemi sırasında hata oluştu');
                    }
                });
            }

            const addEmployeeBtn = document.getElementById('addEmployeeBtn');
            if (addEmployeeBtn) {
                addEmployeeBtn.addEventListener('click', () => {
                    if (!appState.currentWorkplace) {
                        showError('Önce bir işyeri seçmelisiniz');
                        return;
                    }
                    
                    appState.isEditingEmployee = false;
                    appState.currentEmployeeIndex = null;
                    document.getElementById('employeeModalTitle').textContent = 'Yeni Çalışan';
                    document.getElementById('employeeNameInput').value = '';
                    document.getElementById('employeeTcknInput').value = '';
                    document.getElementById('employeeExamDateInput').value = '';
                    
                    const employeeModal = new bootstrap.Modal(document.getElementById('employeeModal'));
                    employeeModal.show();
                });
            }

            const saveEmployeeBtn = document.getElementById('saveEmployeeBtn');
            if (saveEmployeeBtn) {
                saveEmployeeBtn.addEventListener('click', async () => {
                    const name = document.getElementById('employeeNameInput').value.trim();
                    const tckn = document.getElementById('employeeTcknInput').value.trim();
                    const examDate = document.getElementById('employeeExamDateInput').value;

                    if (!name || !tckn) {
                        showError('Ad soyad ve TCKN gereklidir');
                        return;
                    }

                    try {
                        let nextExamDate = '';
                        if (examDate) {
                            const nextDate = new Date(examDate);
                            nextDate.setFullYear(nextDate.getFullYear() + 5);
                            nextExamDate = nextDate.toISOString();
                        }

                        if (appState.isEditingEmployee && appState.currentEmployeeIndex !== null) {
                            const employee = appState.currentEmployees[appState.currentEmployeeIndex];
                            const updatedEmployee = {
                                ...employee,
                                name,
                                tckn,
                                examDate: examDate ? new Date(examDate).toISOString() : '',
                                nextExamDate
                            };
                            await appState.db.updateEmployee(updatedEmployee);
                        } else {
                            const employee = {
                                id: Date.now().toString(),
                                workplaceId: appState.currentWorkplace.id,
                                name,
                                tckn,
                                examDate: examDate ? new Date(examDate).toISOString() : '',
                                nextExamDate,
                                createdAt: new Date().toISOString()
                            };
                            await appState.db.addEmployee(employee);
                        }
                        
                        await loadEmployees(appState.currentWorkplace.id);
                        bootstrap.Modal.getInstance(document.getElementById('employeeModal')).hide();
                    } catch (error) {
                        console.error('Çalışan ekleme/düzenleme hatası:', error);
                        showError('Çalışan işlemi sırasında hata oluştu');
                    }
                });
            }

            const saveEk2Btn = document.getElementById('saveEk2Btn');
            if (saveEk2Btn) {
                saveEk2Btn.addEventListener('click', async () => {
                    const employeeIndex = appState.currentEmployeeIndex;
                    if (employeeIndex === null || !appState.currentEmployees[employeeIndex]) return;

                    const name = document.getElementById('employee-name').value.trim();
                    const tckn = document.getElementById('employee-tckn').value.trim();

                    try {
                        // EK-2 form verilerini topla
                        const formData = {
                            'workplace-title': document.getElementById('workplace-title').value,
                            'workplace-sgk': document.getElementById('workplace-sgk').value,
                            'workplace-address': document.getElementById('workplace-address').value,
                            'workplace-phone': document.getElementById('workplace-phone').value,
                            'workplace-email': document.getElementById('workplace-email').value,
                            'employee-name': name,
                            'employee-tckn': tckn,
                            'employee-birth': document.getElementById('employee-birth').value,
                            'employee-gender': document.getElementById('employee-gender').value,
                            'employee-education': document.getElementById('employee-education').value,
                            'employee-marital': document.getElementById('employee-marital').value,
                            'employee-children': document.getElementById('employee-children').value,
                            'employee-address': document.getElementById('employee-address').value,
                            'employee-phone': document.getElementById('employee-phone').value,
                            'employee-profession': document.getElementById('employee-profession').value,
                            'employee-job': document.getElementById('employee-job').value,
                            'employee-department': document.getElementById('employee-department').value,
                            'symptom-cough': document.getElementById('symptom-cough').checked,
                            'symptom-breath': document.getElementById('symptom-breath').checked,
                            'symptom-chest': document.getElementById('symptom-chest').checked,
                            // Diğer form alanları buraya eklenebilir
                        };

                        // EK-2 formunu veritabanına kaydet
                        const ek2Form = {
                            employeeId: appState.currentEmployees[employeeIndex].id,
                            formData: formData,
                            createdAt: new Date().toISOString()
                        };
                        await appState.db.saveEk2Form(ek2Form);

                        // Çalışan bilgilerini güncelle
                        const employee = {
                            ...appState.currentEmployees[employeeIndex],
                            name,
                            tckn
                        };

                        await appState.db.updateEmployee(employee);
                        await loadEmployees(appState.currentWorkplace.id);
                        bootstrap.Modal.getInstance(document.getElementById('ek2Modal')).hide();
                    } catch (error) {
                        console.error('EK-2 kaydetme hatası:', error);
                        showError('EK-2 kaydedilirken hata oluştu');
                    }
                });
            }
        }

        function initEmployeeActions() {
            const importExcelBtn = document.getElementById('importExcelBtn');
            if (importExcelBtn) {
                importExcelBtn.addEventListener('click', importFromExcel);
            }

            const exportExcelBtn = document.getElementById('exportExcelBtn');
            if (exportExcelBtn) {
                exportExcelBtn.addEventListener('click', exportToExcel);
            }

            const uploadFileBtn = document.getElementById('uploadFileBtn');
            if (uploadFileBtn) {
                uploadFileBtn.addEventListener('click', uploadFile);
            }

            const printEk2Btn = document.getElementById('printEk2Btn');
            if (printEk2Btn) {
                printEk2Btn.addEventListener('click', () => {
                    window.print();
                });
            }
        }

        // Dosya Yükleme
        async function uploadFile() {
            const fileInput = document.getElementById('fileInput');
            if (fileInput.files.length === 0) {
                showError('Lütfen bir dosya seçin');
                return;
            }

            const file = fileInput.files[0];
            const employee = appState.currentEmployees[appState.currentFileUploadIndex];
            
            if (!employee) {
                showError('Çalışan bulunamadı');
                return;
            }
            
            try {
                const reader = new FileReader();
                reader.onload = async (event) => {
                    const fileData = event.target.result;
                    const fileRecord = {
                        id: Date.now().toString(),
                        employeeId: employee.id,
                        workplaceId: appState.currentWorkplace.id,
                        fileName: file.name,
                        fileType: file.type,
                        data: fileData,
                        uploadedAt: new Date().toISOString()
                    };
                    
                    await appState.db.addFile(fileRecord);
                    alert(`${employee.name} için ${file.name} dosyası başarıyla yüklendi`);
                    
                    // Modalı yenile
                    await showFileUploadModal(appState.currentFileUploadIndex);
                };
                reader.readAsArrayBuffer(file);
            } catch (error) {
                console.error('Dosya yükleme hatası:', error);
                showError('Dosya yüklenirken hata oluştu');
            }
        }

        // Excel İşlemleri
        function exportToExcel() {
            try {
                if (!appState.currentWorkplace || !appState.currentEmployees.length) {
                    alert('Dışa aktarılacak veri bulunamadı');
                    return;
                }

                const data = [
                    ['S.No', 'Ad Soyad', 'TCKN', 'Muayene Tarihi', 'Sonraki Muayene Tarihi'],
                    ...appState.currentEmployees.map((emp, index) => [
                        index + 1,
                        emp.name || '',
                        emp.tckn || '',
                        emp.examDate ? formatDate(emp.examDate) : '',
                        emp.nextExamDate ? formatDate(emp.nextExamDate) : ''
                    ])
                ];

                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.aoa_to_sheet(data);
                XLSX.utils.book_append_sheet(wb, ws, 'Çalışan Listesi');

                XLSX.writeFile(wb, `${appState.currentWorkplace.name}_Çalışan_Listesi.xlsx`);
            } catch (error) {
                console.error('Excel export hatası:', error);
                alert('Excel dosyası oluşturulurken hata oluştu');
            }
        }

        async function importFromExcel() {
            try {
                if (!appState.currentWorkplace) {
                    alert('Lütfen önce bir işyeri seçin');
                    return;
                }

                const fileInput = document.createElement('input');
                fileInput.type = 'file';
                fileInput.accept = '.xlsx,.xls,.csv';
                
                fileInput.onchange = async (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    
                    const reader = new FileReader();
                    reader.onload = async (event) => {
                        try {
                            const data = new Uint8Array(event.target.result);
                            const workbook = XLSX.read(data, { type: 'array' });
                            const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                            const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                            
                            if (!jsonData.length) {
                                alert('Excel dosyasında veri bulunamadı');
                                return;
                            }
                            
                            let importedCount = 0;
                            const errors = [];
                            
                            for (const [i, row] of jsonData.entries()) {
                                try {
                                    const name = row['Ad Soyad'] || row['Adı Soyadı'] || row['Ad Soyadı'] || '';
                                    const tckn = String(row['TCKN'] || row['TC Kimlik No'] || row['T.C. Kimlik No'] || '');
                                    
                                    if (!name || !tckn) {
                                        errors.push(`Satır ${i+1}: Ad soyad veya TCKN eksik`);
                                        continue;
                                    }
                                    
                                    if (tckn.length !== 11 || isNaN(tckn)) {
                                        errors.push(`Satır ${i+1}: Geçersiz TCKN (${tckn})`);
                                        continue;
                                    }
                                    
                                    let examDate = '';
                                    if (row['Muayene Tarihi']) {
                                        const date = new Date(row['Muayene Tarihi']);
                                        if (!isNaN(date.getTime())) {
                                            examDate = date.toISOString();
                                        }
                                    }
                                    
                                    let nextExamDate = '';
                                    if (examDate) {
                                        const nextDate = new Date(examDate);
                                        nextDate.setFullYear(nextDate.getFullYear() + 5);
                                        nextExamDate = nextDate.toISOString();
                                    }
                                    
                                    const employee = {
                                        id: Date.now().toString(),
                                        workplaceId: appState.currentWorkplace.id,
                                        name,
                                        tckn,
                                        examDate,
                                        nextExamDate,
                                        createdAt: new Date().toISOString()
                                    };
                                    
                                    await appState.db.addEmployee(employee);
                                    importedCount++;
                                } catch (error) {
                                    errors.push(`Satır ${i+1}: ${error.message}`);
                                }
                            }
                            
                            await loadEmployees(appState.currentWorkplace.id);
                            
                            let resultMessage = `${importedCount} çalışan başarıyla eklendi`;
                            if (errors.length > 0) {
                                resultMessage += `\n\nHatalar:\n${errors.join('\n')}`;
                            }
                            alert(resultMessage);
                        } catch (error) {
                            console.error('Excel import hatası:', error);
                            alert('Excel dosyası okunurken hata oluştu: ' + error.message);
                        }
                    };
                    
                    reader.readAsArrayBuffer(file);
                };
                
                fileInput.click();
            } catch (error) {
                console.error('Excel import hatası:', error);
                alert('Excel import işlemi sırasında hata oluştu: ' + error.message);
            }
        }

        // Global fonksiyonlar
        window.showEk2Modal = showEk2Modal;
        window.showFileUploadModal = showFileUploadModal;
    </script>
</body>
</html>
