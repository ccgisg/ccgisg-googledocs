<!DOCTYPE html>
<html lang="tr">
<head>
    <!-- ... existing head content ... -->
    <style>
        /* Add new style for file list */
        .file-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #eee;
        }
    </style>
</head>
<body>
    <!-- ... existing body ... -->

    <!-- Add new modal for file list -->
    <div class="modal fade" id="fileListModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Yüklenen Dosyalar - <span id="fileListEmployeeName"></span></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="fileListContent" class="list-group"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Kapat</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ... existing script ...

        // Updated backupDatabase function
        async function backupDatabase() {
            try {
                // ... existing backup code ...
                
                const now = new Date();
                const formattedBackupTime = `${now.getFullYear()}-${(now.getMonth()+1).toString().padStart(2, '0')}-${now.getDate().toString().padStart(2, '0')}_${now.getHours().toString().padStart(2, '0')}-${now.getMinutes().toString().padStart(2, '0')}-${now.getSeconds().toString().padStart(2, '0')}`;
                a.download = `isyeri_hekimligi_backup_${formattedBackupTime}.json`;
                
                // ... rest of function ...
            } catch (error) {
                // ... error handling ...
            }
        }

        // Updated uploadFile function
        async function uploadFile() {
            // ... existing code ...
            
            try {
                const reader = new FileReader();
                reader.onload = async (event) => {
                    const fileData = event.target.result;
                    const now = new Date();
                    const formattedFileTime = `${now.getFullYear()}-${(now.getMonth()+1).toString().padStart(2, '0')}-${now.getDate().toString().padStart(2, '0')} ${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}:${now.getSeconds().toString().padStart(2, '0')}`;

                    const fileRecord = {
                        id: Date.now().toString(),
                        employeeId: employee.id,
                        workplaceId: appState.currentWorkplace.id,
                        fileName: `${formattedFileTime} - ${file.name}`,
                        fileType: file.type,
                        data: fileData,
                        uploadedAt: now.toISOString()
                    };
                    
                    // ... rest of function ...
                };
                // ... rest of function ...
            } catch (error) {
                // ... error handling ...
            }
        }

        // New function to show file list
        async function showFileListModal(employeeIndex) {
            const employee = appState.currentEmployees[employeeIndex];
            if (!employee) {
                console.error('Çalışan bulunamadı');
                return;
            }
            
            document.getElementById('fileListEmployeeName').textContent = employee.name;
            const fileListContent = document.getElementById('fileListContent');
            fileListContent.innerHTML = '<div class="text-center py-3"><div class="spinner-border" role="status"><span class="visually-hidden">Yükleniyor...</span></div></div>';

            try {
                const files = await appState.db.getFilesByEmployee(employee.id);
                fileListContent.innerHTML = '';

                if (files.length === 0) {
                    fileListContent.innerHTML = '<div class="alert alert-info text-center">Henüz dosya yüklenmemiş</div>';
                } else {
                    files.forEach(file => {
                        const uploadDate = new Date(file.uploadedAt);
                        const formattedDate = `${uploadDate.getDate().toString().padStart(2, '0')}/${(uploadDate.getMonth()+1).toString().padStart(2, '0')}/${uploadDate.getFullYear()} ${uploadDate.getHours().toString().padStart(2, '0')}:${uploadDate.getMinutes().toString().padStart(2, '0')}`;
                        
                        const listItem = document.createElement('div');
                        listItem.className = 'list-group-item';
                        listItem.innerHTML = `
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="truncate">
                                    <strong class="d-block">${file.fileName}</strong>
                                    <small class="text-muted">${formattedDate}</small>
                                </div>
                                <div class="btn-group">
                                    <button class="btn btn-sm btn-outline-primary download-file-btn" data-id="${file.id}">
                                        <i class="fas fa-download"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger delete-file-btn" data-id="${file.id}">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        `;
                        fileListContent.appendChild(listItem);

                        // Event listeners for buttons
                        listItem.querySelector('.download-file-btn').addEventListener('click', async (e) => {
                            const fileId = e.target.closest('button').getAttribute('data-id');
                            const fileRecord = files.find(f => f.id === fileId);
                            if (fileRecord) {
                                const blob = new Blob([fileRecord.data], { type: fileRecord.fileType });
                                const url = URL.createObjectURL(blob);
                                const a = document.createElement('a');
                                a.href = url;
                                a.download = fileRecord.fileName;
                                document.body.appendChild(a);
                                a.click();
                                document.body.removeChild(a);
                                URL.revokeObjectURL(url);
                            }
                        });

                        listItem.querySelector('.delete-file-btn').addEventListener('click', async (e) => {
                            const fileId = e.target.closest('button').getAttribute('data-id');
                            if (confirm('Bu dosyayı silmek istediğinize emin misiniz?')) {
                                try {
                                    await appState.db.deleteFile(fileId);
                                    listItem.remove(); // Remove from UI immediately
                                } catch (error) {
                                    console.error('Dosya silme hatası:', error);
                                    alert('Dosya silinirken hata oluştu');
                                }
                            }
                        });
                    });
                }
            } catch (error) {
                console.error('Dosyalar yüklenirken hata:', error);
                fileListContent.innerHTML = '<div class="alert alert-danger">Dosyalar yüklenirken hata oluştu</div>';
            }

            const fileListModal = new bootstrap.Modal(document.getElementById('fileListModal'));
            fileListModal.show();
        }

        // Update renderEmployees to add new button
        function renderEmployees(employees) {
            // ... existing code ...
            
            employees.forEach((emp, index) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${emp.name || ''}</td>
                    <td>${emp.tckn || ''}</td>
                    <td>${emp.examDate ? formatDate(emp.examDate) : ''}</td>
                    <td>${emp.nextExamDate ? formatDate(emp.nextExamDate) : ''}</td>
                    <td>
                        <div class="employee-actions">
                            <button class="btn btn-sm btn-primary ek2-btn">EK-2</button>
                            <button class="btn btn-sm btn-secondary upload-btn">EK-2 Yükle</button>
                            <button class="btn btn-sm btn-info show-files-btn">EK-2 Göster</button>
                            <button class="btn btn-sm btn-info edit-employee">Düzenle</button>
                            <button class="btn btn-sm btn-danger delete-employee">Sil</button>
                        </div>
                    </td>
                `;
                
                // ... existing event listeners ...
                
                // Add event listener for new button
                tr.querySelector('.show-files-btn').addEventListener('click', () => {
                    showFileListModal(index);
                });
                
                tbody.appendChild(tr);
            });
        }
    </script>
</body>
</html>
